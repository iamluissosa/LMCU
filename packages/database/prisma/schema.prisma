// 1. Configuraci√≥n del Generador
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// üè¢ N√öCLEO: EMPRESA Y CONFIGURACI√ìN
// ==========================================

model Company {
  id           String  @id @default(uuid())
  name         String
  rif          String  @unique
  address      String
  state        String
  city         String
  taxpayerType String
  phone        String?
  email        String?
  website      String?
  logoUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  settings CompanySettings?
  roles    Role[]
  users    User[]
  products Product[]
  clients  Client[]
  invoices Invoice[]

  // Relaciones de Compras y Tesorer√≠a
  suppliers      Supplier[]
  purchaseOrders PurchaseOrder[]
  purchaseBills  PurchaseBill[]
  goodsReceipts  GoodsReceipt[]
  paymentsOut    PaymentOut[] // Nuevo: Historial de Pagos
}

model CompanySettings {
  id        String  @id @default(uuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Ventas
  invoicePrefix     String @default("FACT-")
  nextInvoiceNumber Int    @default(1)

  // Inventario
  productPrefix   String @default("PROD-")
  nextProductCode Int    @default(1)

  // Compras
  purchaseOrderPrefix String @default("OC-")
  nextPurchaseOrder   Int    @default(1)

  // Tesorer√≠a / Egresos
  paymentOutPrefix     String @default("EGR-")
  nextPaymentOutNumber Int    @default(1)

  // Retenciones (Comprobantes SENIAT)
  nextRetentionIVANumber  Int    @default(1)
  nextRetentionISLRNumber Int    @default(1)
  retentionPrefix         String @default("RET-")

  // A√±o fiscal activo (para control de secuencias)
  fiscalYear Int @default(2026)

  currency String @default("USD")
  timeZone String @default("America/Caracas")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// üõ°Ô∏è SEGURIDAD: USUARIOS Y ROLES
// ==========================================

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  permissions Json     @default("[]")
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, name])
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String?
  roleId        String?
  role          Role?          @relation(fields: [roleId], references: [id])
  roleLegacy    String         @default("USER")
  companyId     String?
  company       Company?       @relation(fields: [companyId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  goodsReceipts GoodsReceipt[]

  // Auditor√≠a
  createdBills    PurchaseBill[]  @relation("BillCreatedBy")
  updatedBills    PurchaseBill[]  @relation("BillUpdatedBy")
  createdOrders   PurchaseOrder[] @relation("OrderCreatedBy")
  updatedOrders   PurchaseOrder[] @relation("OrderUpdatedBy")
  createdPayments PaymentOut[]    @relation("PaymentCreatedBy")
  updatedPayments PaymentOut[]    @relation("PaymentUpdatedBy")
  purchaseOrders  PurchaseOrder[]
  purchaseBills   PurchaseBill[]
  paymentOuts     PaymentOut[]
}

// ==========================================
// üì¶ INVENTARIO Y PRODUCTOS
// ==========================================

model Product {
  id          String  @id @default(uuid())
  code        String
  name        String
  description String?

  // Costos y Precios
  costAverage Decimal @default(0) @db.Decimal(12, 2)
  priceBase   Decimal @db.Decimal(10, 2)

  currentStock Decimal @default(0) @db.Decimal(12, 2)
  imageUrl     String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Relaciones
  invoiceItems       InvoiceItem[]
  purchaseOrderItems PurchaseOrderItem[]
  goodsReceiptItems  GoodsReceiptItem[]
  purchaseBillItems  PurchaseBillItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId, currentStock])
}

// ==========================================
// üöö M√ìDULO DE COMPRAS (PROCUREMENT)
// ==========================================

// 1. PROVEEDORES
model Supplier {
  id        String @id @default(uuid())
  companyId String

  name        String
  rif         String
  email       String?
  phone       String?
  address     String?
  contactName String? // Nuevo campo tras refactor T-01

  retentionISLR Decimal @default(0) @db.Decimal(5, 2)
  paymentTerms  Int     @default(0)

  company        Company         @relation(fields: [companyId], references: [id])
  purchaseOrders PurchaseOrder[]
  bills          PurchaseBill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, rif])
}

enum POStatus {
  OPEN
  PARTIALLY_RECEIVED
  RECEIVED
  BILLED
  CLOSED
  CANCELLED
}

// 2. ORDEN DE COMPRA
model PurchaseOrder {
  id         String @id @default(uuid())
  companyId  String
  supplierId String

  orderNumber String
  status      POStatus @default(OPEN)

  currencyCode String  @default("USD")
  exchangeRate Decimal @default(1.0000) @db.Decimal(12, 4)

  totalAmount Decimal @default(0) @db.Decimal(12, 2)
  notes       String?

  company    Company             @relation(fields: [companyId], references: [id])
  supplier   Supplier            @relation(fields: [supplierId], references: [id])
  items      PurchaseOrderItem[]
  receptions GoodsReceipt[]
  bills      PurchaseBill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  // Auditor√≠a
  createdById String?
  createdBy   User?     @relation("OrderCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?     @relation("OrderUpdatedBy", fields: [updatedById], references: [id])
  deletedAt   DateTime?

  @@unique([companyId, orderNumber])
}

model PurchaseOrderItem {
  id              String @id @default(uuid())
  purchaseOrderId String
  productId       String

  quantityOrdered Decimal @db.Decimal(12, 2)
  unitPrice       Decimal @db.Decimal(12, 2)

  quantityReceived Decimal @default(0) @db.Decimal(12, 2)
  isClosed         Boolean @default(false)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  product       Product       @relation(fields: [productId], references: [id])
}

// 3. RECEPCI√ìN DE MERCANC√çA
model GoodsReceipt {
  id              String   @id @default(uuid())
  companyId       String
  purchaseOrderId String
  receivedAt      DateTime @default(now())

  receiptNumber String
  comments      String?

  receivedById String?
  receivedBy   User?   @relation(fields: [receivedById], references: [id])

  company       Company            @relation(fields: [companyId], references: [id])
  purchaseOrder PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id])
  items         GoodsReceiptItem[]
}

model GoodsReceiptItem {
  id             String @id @default(uuid())
  goodsReceiptId String
  productId      String

  quantity Decimal @db.Decimal(12, 2)

  goodsReceipt GoodsReceipt @relation(fields: [goodsReceiptId], references: [id])
  product      Product      @relation(fields: [productId], references: [id])
}

// ==========================================
// üí∏ TESORER√çA Y PAGOS (CUENTAS POR PAGAR)
// ==========================================

enum BillStatus {
  UNPAID
  PAID
  VOID
  PARTIAL // Nuevo estado para pagos parciales
}

// 4. FACTURA DE COMPRA (Cuenta por Pagar con Retenciones)
model PurchaseBill {
  id              String  @id @default(uuid())
  companyId       String
  supplierId      String
  purchaseOrderId String?

  invoiceNumber String
  controlNumber String?
  issueDate     DateTime
  dueDate       DateTime? // Fecha de Vencimiento

  // Montos Base
  currencyCode String  @default("USD")
  exchangeRate Decimal @db.Decimal(12, 4)

  // Desglose Fiscal (Venezuela)
  exemptAmount  Decimal @default(0) @db.Decimal(12, 2) // Exento
  taxableAmount Decimal @default(0) @db.Decimal(12, 2) // Base Imponible
  taxRate       Decimal @default(16.00) @db.Decimal(5, 2) // % IVA
  taxAmount     Decimal @default(0) @db.Decimal(12, 2) // Monto IVA

  // RETENCIONES (Se resta al pago del proveedor)
  retentionIVA  Decimal @default(0) @db.Decimal(12, 2)
  rateRetIVA    Decimal @default(75) @db.Decimal(5, 2) // % usual 75 o 100
  receiptRetIVA String? // N¬∞ Comprobante

  retentionISLR  Decimal @default(0) @db.Decimal(12, 2)
  rateRetISLR    Decimal @default(0) @db.Decimal(5, 2)
  receiptRetISLR String? // N¬∞ Comprobante

  // IGTF (Se suma al pago si es en divisa efectivo)
  igtfAmount Decimal @default(0) @db.Decimal(12, 2)

  // Totales
  totalAmount Decimal @db.Decimal(12, 2) // Total Factura
  paidAmount  Decimal @default(0) @db.Decimal(12, 2) // Lo pagado hasta ahora

  status BillStatus @default(UNPAID)
  inBook Boolean    @default(true) // ¬øVa al libro de compras?

  company       Company        @relation(fields: [companyId], references: [id])
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  items    PurchaseBillItem[]
  payments PaymentOutDetail[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  // Auditor√≠a
  createdById String?
  createdBy   User?     @relation("BillCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?     @relation("BillUpdatedBy", fields: [updatedById], references: [id])
  deletedAt   DateTime?

  @@index([companyId, status])
  @@index([supplierId, status])
  @@index([issueDate])
}

// DETALLE DE FACTURA DE COMPRA (Items)
model PurchaseBillItem {
  id             String       @id @default(uuid())
  purchaseBillId String
  purchaseBill   PurchaseBill @relation(fields: [purchaseBillId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Decimal @db.Decimal(12, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  taxRate   Decimal @default(0) @db.Decimal(5, 2) // Nueva columna para IVA por √≠tem
  islrRate  Decimal @default(0) @db.Decimal(5, 2) // Retenci√≥n ISLR manual por √≠tem
  totalLine Decimal @db.Decimal(12, 2)
}

enum PaymentMethod {
  CASH_USD
  CASH_VES
  ZELLE
  TRANSFER_VES
  TRANSFER_USD
  PAGO_MOVIL
}

// 5. EGRESOS / PAGOS (NUEVO)
model PaymentOut {
  id            String @id @default(uuid())
  companyId     String
  paymentNumber String // EGR-0001

  paymentDate DateTime @default(now())

  method    PaymentMethod
  reference String? // Ref Bancaria
  bankName  String?

  currencyCode String  @default("USD")
  exchangeRate Decimal @default(1.0000) @db.Decimal(12, 4)
  amountPaid   Decimal @db.Decimal(12, 2) // Monto que sali√≥ del banco

  notes String?

  company Company @relation(fields: [companyId], references: [id])

  // Detalle de qu√© facturas cubre este pago
  details PaymentOutDetail[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  // Auditor√≠a
  createdById String?
  createdBy   User?     @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?     @relation("PaymentUpdatedBy", fields: [updatedById], references: [id])
  deletedAt   DateTime?

  @@index([companyId, paymentDate])
}

model PaymentOutDetail {
  id             String @id @default(uuid())
  paymentOutId   String
  purchaseBillId String

  amountApplied Decimal @db.Decimal(12, 2) // Monto aplicado a esta factura

  paymentOut   PaymentOut   @relation(fields: [paymentOutId], references: [id])
  purchaseBill PurchaseBill @relation(fields: [purchaseBillId], references: [id])
}

// ==========================================
// ü§ù VENTAS Y CLIENTES
// ==========================================

model Client {
  id      String  @id @default(uuid())
  name    String
  rif     String?
  address String?
  phone   String?
  email   String?

  companyId String
  company   Company   @relation(fields: [companyId], references: [id])
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String  @id @default(uuid())
  invoiceNumber Int
  controlNumber String?
  status        String  @default("DRAFT")

  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  date    DateTime  @default(now())
  dueDate DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  items InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, invoiceNumber])
}

model InvoiceItem {
  id        String  @id @default(uuid())
  quantity  Decimal @db.Decimal(12, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  taxRate   Decimal @default(16.00) @db.Decimal(5, 2)
  totalLine Decimal @db.Decimal(12, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])
}

// ==========================================
// üí± MONEDAS Y TASAS DE CAMBIO
// ==========================================

model ExchangeRate {
  id String @id @default(uuid())

  date DateTime @default(now()) // Fecha y Hora exacta del registro

  fromCurrency String // USD
  toCurrency   String // VES
  rate         Decimal @db.Decimal(12, 4) // Tasa de cambio (Ej: 36.5432)

  source String? // BCV, PARALELO, MANUAL

  createdAt DateTime @default(now())
}
