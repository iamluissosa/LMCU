// 1. Configuraci√≥n del Generador
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// üè¢ N√öCLEO: EMPRESA Y CONFIGURACI√ìN
// ==========================================

model Company {
  id           String  @id @default(uuid())
  name         String
  rif          String  @unique
  address      String
  state        String
  city         String
  taxpayerType String
  phone        String?
  email        String?
  website      String?
  logoUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  settings CompanySettings?
  roles    Role[]
  users    User[]
  products Product[]
  clients  Client[]
  invoices Invoice[]

  // Relaciones de Compras (NUEVO)
  suppliers      Supplier[]
  purchaseOrders PurchaseOrder[]
  purchaseBills  PurchaseBill[]
  goodsReceipts  GoodsReceipt[]
}

model CompanySettings {
  id        String  @id @default(uuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Ventas
  invoicePrefix     String @default("FACT-")
  nextInvoiceNumber Int    @default(1)

  // Inventario
  productPrefix   String @default("PROD-")
  nextProductCode Int    @default(1)

  // Compras (NUEVO)
  purchaseOrderPrefix String @default("OC-")
  nextPurchaseOrder   Int    @default(1)

  currency String @default("USD")
  timeZone String @default("America/Caracas")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// üõ°Ô∏è SEGURIDAD: USUARIOS Y ROLES
// ==========================================

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  permissions Json     @default("[]")
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, name])
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String?
  roleId        String?
  role          Role?          @relation(fields: [roleId], references: [id])
  roleLegacy    String         @default("USER")
  companyId     String?
  company       Company?       @relation(fields: [companyId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  goodsReceipts GoodsReceipt[]
}

// ==========================================
// üì¶ INVENTARIO Y PRODUCTOS
// ==========================================

model Product {
  id          String  @id @default(uuid())
  code        String
  name        String
  description String?

  // Costos y Precios
  costAverage Decimal @default(0) @db.Decimal(12, 2) // Costo Promedio (NUEVO)
  priceBase   Decimal @db.Decimal(10, 2) // Precio de Venta

  currentStock Decimal @default(0) @db.Decimal(12, 2) // Stock actual (Ahora soporta decimales)
  imageUrl     String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Relaciones
  invoiceItems       InvoiceItem[]
  purchaseOrderItems PurchaseOrderItem[] // (NUEVO)
  goodsReceiptItems  GoodsReceiptItem[] // (NUEVO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
}

// ==========================================
// üöö M√ìDULO DE COMPRAS (PROCUREMENT)
// ==========================================

// 1. PROVEEDORES
model Supplier {
  id        String @id @default(uuid())
  companyId String

  name    String
  rif     String
  email   String?
  phone   String?
  address String?

  retentionISLR Decimal @default(0) @db.Decimal(5, 2)
  paymentTerms  Int     @default(0)

  company        Company         @relation(fields: [companyId], references: [id])
  purchaseOrders PurchaseOrder[]
  bills          PurchaseBill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, rif])
}

// Status de la Orden de Compra
enum POStatus {
  OPEN
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
  CANCELLED
}

// 2. ORDEN DE COMPRA (El Contrato)
model PurchaseOrder {
  id         String @id @default(uuid())
  companyId  String
  supplierId String

  orderNumber String
  status      POStatus @default(OPEN)

  currencyCode String  @default("USD")
  exchangeRate Decimal @default(1.0000) @db.Decimal(12, 4)

  totalAmount Decimal @default(0) @db.Decimal(12, 2)
  notes       String?

  company    Company             @relation(fields: [companyId], references: [id])
  supplier   Supplier            @relation(fields: [supplierId], references: [id])
  items      PurchaseOrderItem[]
  receptions GoodsReceipt[]
  bills      PurchaseBill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, orderNumber])
}

model PurchaseOrderItem {
  id              String @id @default(uuid())
  purchaseOrderId String
  productId       String

  quantityOrdered Decimal @db.Decimal(12, 2)
  unitPrice       Decimal @db.Decimal(12, 2)

  quantityReceived Decimal @default(0) @db.Decimal(12, 2)
  isClosed         Boolean @default(false)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  product       Product       @relation(fields: [productId], references: [id])
}

// 3. RECEPCI√ìN DE MERCANC√çA (Entrada al Almac√©n)
model GoodsReceipt {
  id              String   @id @default(uuid())
  companyId       String
  purchaseOrderId String
  receivedAt      DateTime @default(now())

  receiptNumber String
  comments      String?

  receivedById String?
  receivedBy   User?   @relation(fields: [receivedById], references: [id])

  company       Company            @relation(fields: [companyId], references: [id])
  purchaseOrder PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id])
  items         GoodsReceiptItem[]
}

model GoodsReceiptItem {
  id             String @id @default(uuid())
  goodsReceiptId String
  productId      String

  quantity Decimal @db.Decimal(12, 2)

  goodsReceipt GoodsReceipt @relation(fields: [goodsReceiptId], references: [id])
  product      Product      @relation(fields: [productId], references: [id])
}

// Status de la Factura
enum BillStatus {
  UNPAID
  PAID
  VOID
}

// 4. FACTURA DE COMPRA (Cuenta por Pagar)
model PurchaseBill {
  id              String  @id @default(uuid())
  companyId       String
  supplierId      String
  purchaseOrderId String?

  invoiceNumber String
  controlNumber String?
  issueDate     DateTime

  currencyCode String  @default("VES")
  exchangeRate Decimal @db.Decimal(12, 4)

  totalAmount Decimal    @db.Decimal(12, 2)
  status      BillStatus @default(UNPAID)

  company       Company        @relation(fields: [companyId], references: [id])
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// ü§ù VENTAS Y CLIENTES
// ==========================================

model Client {
  id      String  @id @default(uuid())
  name    String
  rif     String?
  address String?
  phone   String?
  email   String?

  companyId String
  company   Company   @relation(fields: [companyId], references: [id])
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String  @id @default(uuid())
  invoiceNumber Int
  controlNumber String?
  status        String  @default("DRAFT")

  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  date    DateTime  @default(now())
  dueDate DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  items InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, invoiceNumber])
}

model InvoiceItem {
  id        String  @id @default(uuid())
  quantity  Decimal @db.Decimal(12, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  taxRate   Decimal @default(16.00) @db.Decimal(5, 2)
  totalLine Decimal @db.Decimal(12, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])
}
